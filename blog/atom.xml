<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://conradj3.github.io/digital-locker/blog</id>
    <title>Nov4  Blog</title>
    <updated>2022-04-28T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://conradj3.github.io/digital-locker/blog"/>
    <subtitle>Nov4  Blog</subtitle>
    <icon>https://conradj3.github.io/digital-locker/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Production Down]]></title>
        <id>AKS</id>
        <link href="https://conradj3.github.io/digital-locker/blog/AKS"/>
        <updated>2022-04-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In short Duke, a shit storm.]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="in-short-duke-a-shit-storm">In short Duke, a shit storm.<a class="hash-link" href="#in-short-duke-a-shit-storm" title="Direct link to heading">​</a></h2><p>Thursday morning started just great. We had a deployment into a production Kubernetes cluster failing to pull container images from our Azure Container Registry. The <code>Azure Service Principal</code> account secret used by the <code>Kubernetes</code> cluster had expired and needed to be renewed.</p><p>We got around to addressing the new deployment later in the afternoon when many of our staff had left for the day. One might ask why we managed to tackle this problem in the afternoon if it's production? This is because it had no impact on current solutions on the <code>Kubernetes</code> and only prevented new feature deployments that were not urgent. So we created a new service principal using the Azure CLI and updated the Kubernetes cluster credentials. Of course, we had to give permissions to the Container Registry to pull images <code>acr pull</code>, and we also drained and deallocated nodes in hopes the new credential would allow permission to pull images. This was a mistake, a bad mistake. As we started draining nodes and deallocating and bringing them back online because they would not reboot... we learned we were in the shit.</p><p>Our applications started experiencing a problem with the core DNS service inside Kubernetes and were routing outside our cluster. We issued a priority incident, eventually after chasing logs, firewalls, and all the fun stuff. We made a call to reboot the Kubernetes Service. Fantastic! After the reboot, all our daemon sets and pods were up, and so was our primary graph service. We decided we were ready to call it for the night, but we were interrupted by a keen team member that they were seeing something extremely odd. Low and behold, the pods came up, but many of the replicas started crashing. </p><p>So we had intermittent service of our primary graph service, and we made a call to downgrade the priority. Calls were bouncing from our applications, but at least some were going through. I ended the night in a depressed state as I was sure we could resolve the problem if we continued to stare at the screen and solution. One of our product owners pulled the plug and said, " Let us get back at this tomorrow morning after getting some sleep." Sure enough, we did.</p><p>After catching about 4 hours of sleep, because my brain was racking on what could be causing this problem after we all retired for the night, I woke up to take my kids to school. Our team was all present in a call at 8:00 AM on the dot. We learned we had missed a step within the hour while creating the <code>Service Principal</code>. It lacked the <code>network contributor</code> role to update the Kubernetes Route Tables, which was the root cause of Kubernetes pods were trying to route outside the cluster. After adding <code>network contributor</code> all our pods came back to life, and service was restored.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>After describing our mistakes one could reference <a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-service-principal?tabs=azure-cli" target="_blank" rel="noopener noreferrer">Azure - Kubernetes Service Principals</a></p><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p>This is were things went south.</p></div></div><p>When running the follow command after service principal creation;</p><div class="language-bash codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-bash codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az role assignment create --assignee </span><span class="token operator">&lt;</span><span class="token plain">appId</span><span class="token operator">&gt;</span><span class="token plain"> --scope </span><span class="token operator">&lt;</span><span class="token plain">resourceScope</span><span class="token operator">&gt;</span><span class="token plain"> --role Contributor</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We required both of the scopes receive contributor assignment:</p><ul><li>/subscriptions/<strong><em>guid</em></strong>/resourceGroups/myResourceGroup </li><li>/subscriptions/<strong><em>guid</em></strong>/resourceGroups/myResourceGroupVnet/providers/Microsoft.Network/virtualNetworks/myVnet</li></ul><p>The official wording says "or" but it was an "and" in our environment. Simple, but caused a hell of a headache and crunch session in the moment to try and bring the production services back to a fully restored state. </p><p>We attempted to resolve this on our own but several of the credentials and individual rbac prevent a lot of engineers from fixing this due to the ownership of the Service Principal / Subscription roles preventing individuals from adding roles to identity.  We were much relieved when services were restored hope this read might help someone who might encounter this.</p>]]></content>
        <author>
            <name>Conrad</name>
            <uri>https://github.com/conradj3</uri>
        </author>
        <category label="Azure" term="Azure"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Graph" term="Graph"/>
        <category label="Identity" term="Identity"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Welcome]]></title>
        <id>welcome</id>
        <link href="https://conradj3.github.io/digital-locker/blog/welcome"/>
        <updated>2022-04-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Hello All,]]></summary>
        <content type="html"><![CDATA[<p>Hello All,</p><p>Welcome to my blog.  I attend to use this blog for daily problems we face with modern day infrastructure and applications.  I hope you enjoy the post and happy reading!</p>]]></content>
        <author>
            <name>Conrad</name>
            <uri>https://github.com/conradj3</uri>
        </author>
        <category label="hello" term="hello"/>
    </entry>
</feed>